{% extends "base.html" %}

{% block title %}Practice Session - LeetCode SRS{% endblock %}

{% block content %}
<div class="session-container">
    <div class="session-header">
        <h1>Practice Session</h1>
        <div class="session-info">
            <span class="session-progress">
                Problem <span id="current-problem">1</span> of {{ problems|length }}
            </span>
            <div class="session-timer">
                <span id="timer">00:00</span>
            </div>
        </div>
    </div>

    <div class="session-content" id="session-content">
        {% for problem in problems %}
            <div class="problem-card" data-problem-id="{{ problem.id }}" {% if not loop.first %}style="display: none;"{% endif %}>
                <div class="problem-header">
                    <h2>{{ problem.title or problem.slug.replace('-', ' ').title() }}</h2>
                    <div class="problem-meta">
                        {% if problem.number %}
                            <span class="problem-number">#{{ problem.number }}</span>
                        {% endif %}
                        {% if problem.difficulty %}
                            <span class="difficulty {{ problem.difficulty.lower() }}">{{ problem.difficulty }}</span>
                        {% endif %}
                    </div>
                </div>

                <div class="problem-link-section">
                    <a href="{{ problem.url }}" target="_blank" class="problem-link">
                        Open Problem in LeetCode
                        <span class="external-icon">‚Üó</span>
                    </a>
                </div>

                {% if problem.tags %}
                    <div class="problem-tags">
                        {% for tag in problem.tags.split(',') %}
                            <span class="tag">{{ tag.strip() }}</span>
                        {% endfor %}
                    </div>
                {% endif %}

                <div class="rating-section">
                    <h3>How did you do?</h3>
                    <div class="rating-buttons">
                        <button class="rating-btn rating-0" data-rating="0" data-key="0">
                            <span class="rating-emoji">üòµ</span>
                            <span class="rating-label">Failed</span>
                            <span class="rating-shortcut">0</span>
                        </button>
                        <button class="rating-btn rating-1" data-rating="1" data-key="1">
                            <span class="rating-emoji">üò∞</span>
                            <span class="rating-label">Very Hard</span>
                            <span class="rating-shortcut">1</span>
                        </button>
                        <button class="rating-btn rating-2" data-rating="2" data-key="2">
                            <span class="rating-emoji">üòì</span>
                            <span class="rating-label">Hard</span>
                            <span class="rating-shortcut">2</span>
                        </button>
                        <button class="rating-btn rating-3" data-rating="3" data-key="3">
                            <span class="rating-emoji">üòê</span>
                            <span class="rating-label">Medium</span>
                            <span class="rating-shortcut">3</span>
                        </button>
                        <button class="rating-btn rating-4" data-rating="4" data-key="4">
                            <span class="rating-emoji">üòä</span>
                            <span class="rating-label">Good</span>
                            <span class="rating-shortcut">4</span>
                        </button>
                        <button class="rating-btn rating-5" data-rating="5" data-key="5">
                            <span class="rating-emoji">üòé</span>
                            <span class="rating-label">Easy</span>
                            <span class="rating-shortcut">5</span>
                        </button>
                    </div>
                    <p class="rating-hint">Use keyboard shortcuts 0-5 or click the buttons</p>
                </div>

                <div class="session-controls">
                    <button class="btn btn-secondary skip-btn" data-problem-id="{{ problem.id }}">
                        Skip for Now
                    </button>
                    <button class="btn btn-warning pause-btn" onclick="pauseSession()">
                        ‚è∏Ô∏è Pause Session
                    </button>
                    <button class="btn btn-danger abandon-btn" onclick="abandonSession()">
                        üõë End Session
                    </button>
                </div>
            </div>
        {% endfor %}
    </div>

    <div class="session-complete" id="session-complete" style="display: none;">
        <div class="complete-content">
            <div class="complete-icon">üéâ</div>
            <h2>Session Complete!</h2>
            <p>Great job! You've completed all problems in this session.</p>
            <div class="session-summary" id="session-summary">
                <!-- Will be populated by JavaScript -->
            </div>
            <div class="complete-actions">
                <a href="{{ url_for('dashboard') }}" class="btn btn-primary">Back to Dashboard</a>
                <a href="{{ url_for('practice_session') }}" class="btn btn-secondary">Start New Session</a>
            </div>
        </div>
    </div>
</div>

<div class="session-progress-bar">
    <div class="progress-fill" id="progress-fill"></div>
</div>

{% endblock %}

{% block scripts %}
<script>
// Session management
let currentProblemIndex = 0;
let totalProblems = {{ problems|length }};
let sessionStartTime = Date.now();
let problemStartTime = Date.now();
let reviewedProblems = 0;
let sessionData = [];

// Timer
function updateTimer() {
    const elapsed = Math.floor((Date.now() - problemStartTime) / 1000);
    const minutes = Math.floor(elapsed / 60);
    const seconds = elapsed % 60;
    document.getElementById('timer').textContent =
        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}

setInterval(updateTimer, 1000);

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    if (e.key >= '0' && e.key <= '5') {
        const rating = parseInt(e.key);
        submitRating(rating);
    } else if (e.key === 's' || e.key === 'S') {
        skipProblem();
    }
});

// Rating buttons
document.querySelectorAll('.rating-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const rating = parseInt(this.dataset.rating);
        submitRating(rating);
    });
});

// Skip buttons
document.querySelectorAll('.skip-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        skipProblem();
    });
});

function submitRating(rating) {
    const currentCard = document.querySelector('.problem-card:not([style*="display: none"])');
    if (!currentCard) return;

    const problemId = currentCard.dataset.problemId;
    const timeSpent = Math.floor((Date.now() - problemStartTime) / 1000);

    // Disable all buttons
    currentCard.querySelectorAll('button').forEach(btn => btn.disabled = true);

    fetch('/session/review', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            problem_id: parseInt(problemId),
            rating: rating,
            time_spent: timeSpent
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            sessionData.push({
                rating: rating,
                timeSpent: timeSpent
            });
            nextProblem();
        } else {
            alert('Error submitting review: ' + data.error);
            // Re-enable buttons
            currentCard.querySelectorAll('button').forEach(btn => btn.disabled = false);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error submitting review');
        currentCard.querySelectorAll('button').forEach(btn => btn.disabled = false);
    });
}

function skipProblem() {
    nextProblem();
}

function nextProblem() {
    currentProblemIndex++;
    reviewedProblems++;

    // Update progress
    updateProgress();

    if (currentProblemIndex >= totalProblems) {
        completeSession();
        return;
    }

    // Hide current problem
    document.querySelectorAll('.problem-card').forEach(card => {
        card.style.display = 'none';
    });

    // Show next problem
    const nextCard = document.querySelectorAll('.problem-card')[currentProblemIndex];
    nextCard.style.display = 'block';

    // Update counter and reset timer
    document.getElementById('current-problem').textContent = currentProblemIndex + 1;
    problemStartTime = Date.now();
}

function updateProgress() {
    const progress = (reviewedProblems / totalProblems) * 100;
    document.getElementById('progress-fill').style.width = progress + '%';
}

function completeSession() {
    // Hide session content
    document.getElementById('session-content').style.display = 'none';

    // Show completion screen
    document.getElementById('session-complete').style.display = 'block';

    // Update summary
    const totalTime = Math.floor((Date.now() - sessionStartTime) / 1000 / 60);
    const avgRating = sessionData.length > 0 ?
        (sessionData.reduce((sum, item) => sum + item.rating, 0) / sessionData.length).toFixed(1) : 0;

    document.getElementById('session-summary').innerHTML = `
        <div class="summary-stats">
            <div class="summary-stat">
                <span class="summary-number">${reviewedProblems}</span>
                <span class="summary-label">Problems Reviewed</span>
            </div>
            <div class="summary-stat">
                <span class="summary-number">${totalTime}</span>
                <span class="summary-label">Minutes</span>
            </div>
            <div class="summary-stat">
                <span class="summary-number">${avgRating}</span>
                <span class="summary-label">Avg Rating</span>
            </div>
        </div>
    `;

    // Complete session on server
    fetch('/session/complete', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    });
}

function pauseSession() {
    if (confirm('Pause your practice session? You can resume it later.')) {
        fetch('/session/pause', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Session paused! You can resume from the dashboard.');
                window.location.href = '/';
            } else {
                alert('Error pausing session: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error pausing session');
        });
    }
}

function abandonSession() {
    if (confirm('End your practice session? This will mark it as completed.')) {
        fetch('/session/abandon', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Session ended. Great work!');
                window.location.href = '/';
            } else {
                alert('Error ending session: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error ending session');
        });
    }
}

// Initialize progress
updateProgress();
</script>
{% endblock %}