{% extends "base.html" %}

{% block title %}Bookmarklet - LeetCode SRS{% endblock %}

{% block content %}
<div class="bookmarklet-page">
    <div class="page-header">
        <h1>LeetCode SRS Bookmarklet</h1>
        <p class="subtitle">One-click problem adding from any LeetCode page</p>
    </div>

    <div class="bookmarklet-section">
        <div class="installation-card">
            <h2>📌 Installation</h2>
            <p>Drag this bookmarklet to your bookmarks bar:</p>

            <div class="bookmarklet-link-container">
                <a href="javascript:(function(){function showNotification(message,type){type=type||'success';const existing=document.querySelector('.leetcode-srs-notification');if(existing)existing.remove();const notification=document.createElement('div');notification.className='leetcode-srs-notification';let backgroundColor='#4CAF50';if(type==='error')backgroundColor='#f44336';else if(type==='warning')backgroundColor='#ff9800';notification.style.cssText='position:fixed;top:20px;right:20px;background:'+backgroundColor+';color:white;padding:12px 20px;border-radius:6px;font-family:Arial,sans-serif;font-size:14px;z-index:10000;box-shadow:0 4px 12px rgba(0,0,0,0.15);max-width:300px;';let icon='✅';if(type==='error')icon='❌';else if(type==='warning')icon='⚠️';notification.textContent=icon+' '+message;document.body.appendChild(notification);setTimeout(function(){if(notification.parentElement)notification.remove()},5000)}const url=window.location.href;if(!url.includes('leetcode.com/problems/')){showNotification('Please navigate to a LeetCode problem page first!','error');return}if(url.includes('/submissions/')){showNotification('Cannot extract from submissions page. Go to the main problem page.','error');return}if(url.includes('/solution/')){showNotification('Cannot extract from solution page. Go to the main problem page.','error');return}if(url.includes('/discuss/')){showNotification('Cannot extract from discussion page. Go to the main problem page.','error');return}function extractFromNextData(){try{const nextDataScript=document.querySelector('#__NEXT_DATA__');if(!nextDataScript)throw new Error('__NEXT_DATA__ not found');const data=JSON.parse(nextDataScript.textContent);const queries=data.props.pageProps.dehydratedState.queries||[];let question=null;for(let i=0;i<queries.length;i++){const query=queries[i];if(query.state&&query.state.data&&query.state.data.question){question=query.state.data.question;console.log('Found question data in query:',query.queryKey);break}}if(!question)throw new Error('Question data not found in any query');let questionNumber=null;if(question.frontendQuestionId){questionNumber=parseInt(question.frontendQuestionId)}else if(question.questionFrontendId){questionNumber=parseInt(question.questionFrontendId)}else if(question.questionId){questionNumber=parseInt(question.questionId)}else if(question.id){questionNumber=parseInt(question.id)}if(!questionNumber&&question.title){const titleMatch=question.title.match(/^(\\d+)\\./);if(titleMatch){questionNumber=parseInt(titleMatch[1])}}return{title:question.title,number:questionNumber,difficulty:question.difficulty,tags:question.topicTags?question.topicTags.map(function(tag){return tag.name}):[],description:question.content||'',slug:question.titleSlug}}catch(error){console.log('Failed to extract from __NEXT_DATA__:',error);return null}}const extractedData=extractFromNextData();const problemData={url:url,title:extractedData?extractedData.title:'',slug:extractedData?extractedData.slug:url.split('/')[4],number:extractedData?extractedData.number:null,difficulty:extractedData?extractedData.difficulty:'',tags:extractedData?extractedData.tags:[],description:extractedData?extractedData.description:''};if(!problemData.title||!extractedData.title){const h1=document.querySelector('h1');if(h1)problemData.title=h1.textContent.trim()}if(!problemData.title||problemData.title.length<3){showNotification('Failed to extract problem title. Please ensure you are on the main problem page.','error');return}const hasValidData=extractedData&&(extractedData.difficulty||extractedData.number||(extractedData.tags&&extractedData.tags.length>0)||(extractedData.description&&extractedData.description.length>50));if(!hasValidData){showNotification('Failed to extract problem data. Please refresh the page and try again.','error');return}const warnings=[];if(!extractedData.difficulty)warnings.push('difficulty');if(!extractedData.number)warnings.push('problem number');if(!extractedData.tags||extractedData.tags.length===0)warnings.push('tags');if(warnings.length>0){showNotification('Could not extract: '+warnings.join(', ')+'. Problem will be saved but may need manual updates.','warning')}showNotification('Extracting problem data...','success');setTimeout(function(){sendToSRS(problemData)},500);function sendToSRS(data){fetch('http://localhost:1234/api/add-problem',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)}).then(function(response){if(!response.ok)throw new Error('HTTP error! status: '+response.status);return response.json()}).then(function(result){if(!result.success)throw new Error(result.error||'Unknown error occurred');showNotification(result.message||'Operation completed!','success')}).catch(function(error){console.error('Error sending to SRS:',error);if(error.message.includes('Failed to fetch')||error.message.includes('NetworkError')){showNotification('Cannot connect to SRS app. Make sure it is running on localhost:1234','error')}else{showNotification('Error: '+error.message,'error')}})}})();" class="bookmarklet-link">
                    📚 Add to LeetCode SRS
                </a>
            </div>

            <div class="installation-steps">
                <ol>
                    <li>Make sure your bookmarks bar is visible in your browser</li>
                    <li>Drag the blue "Add to LeetCode SRS" button above to your bookmarks bar</li>
                    <li>Navigate to any LeetCode problem page</li>
                    <li>Click the bookmarklet in your bookmarks bar</li>
                    <li>The problem will be automatically added to your SRS collection!</li>
                </ol>
            </div>
        </div>

        <div class="features-card">
            <h2>✨ What it extracts</h2>
            <div class="features-grid">
                <div class="feature">
                    <strong>Problem Title</strong>
                    <span>Automatically captures the problem name</span>
                </div>
                <div class="feature">
                    <strong>Problem Number</strong>
                    <span>Extracts the LeetCode problem number</span>
                </div>
                <div class="feature">
                    <strong>Difficulty Level</strong>
                    <span>Easy, Medium, or Hard classification</span>
                </div>
                <div class="feature">
                    <strong>Topic Tags</strong>
                    <span>All associated tags (Array, DP, etc.)</span>
                </div>
                <div class="feature">
                    <strong>Full Problem Description</strong>
                    <span>Complete problem statement with examples</span>
                </div>
                <div class="feature">
                    <strong>URL & Slug</strong>
                    <span>Direct link and problem identifier</span>
                </div>
            </div>
        </div>

        <div class="troubleshooting-card">
            <h2>🔧 Troubleshooting</h2>
            <div class="troubleshooting-list">
                <div class="troubleshooting-item">
                    <strong>Bookmarklet doesn't work?</strong>
                    <p>Make sure your LeetCode SRS app is running at <code>http://localhost:1234</code></p>
                </div>
                <div class="troubleshooting-item">
                    <strong>Can't drag the bookmarklet?</strong>
                    <p>Right-click the bookmarklet button and select "Bookmark this link" or "Add to bookmarks"</p>
                </div>
                <div class="troubleshooting-item">
                    <strong>Not extracting problem data?</strong>
                    <p>LeetCode may have updated their page structure. The bookmarklet will still add the URL and you can edit details manually.</p>
                </div>
                <div class="troubleshooting-item">
                    <strong>CORS or network errors?</strong>
                    <p>Ensure the Flask app is running and accessible. Some browsers may block cross-origin requests.</p>
                </div>
            </div>
        </div>

        <div class="demo-card">
            <h2>🎬 How it works</h2>
            <div class="demo-steps">
                <div class="demo-step">
                    <div class="demo-number">1</div>
                    <div class="demo-content">
                        <strong>Visit any LeetCode problem</strong>
                        <p>Navigate to a problem page like leetcode.com/problems/two-sum/</p>
                    </div>
                </div>
                <div class="demo-step">
                    <div class="demo-number">2</div>
                    <div class="demo-content">
                        <strong>Click the bookmarklet</strong>
                        <p>Click "Add to LeetCode SRS" in your bookmarks bar</p>
                    </div>
                </div>
                <div class="demo-step">
                    <div class="demo-number">3</div>
                    <div class="demo-content">
                        <strong>See confirmation</strong>
                        <p>A green notification appears confirming the problem was added</p>
                    </div>
                </div>
                <div class="demo-step">
                    <div class="demo-number">4</div>
                    <div class="demo-content">
                        <strong>Start practicing!</strong>
                        <p>Return to your SRS app to begin spaced repetition practice</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="manual-alternative">
        <h3>Prefer manual entry?</h3>
        <p>You can also add problems manually on the <a href="{{ url_for('problems') }}">Problems page</a>.</p>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// Check if the SRS app is running
fetch('http://localhost:1234/api/due-problems')
    .then(response => {
        if (response.ok) {
            document.querySelector('.bookmarklet-link').style.opacity = '1';
        }
    })
    .catch(error => {
        const warning = document.createElement('div');
        warning.className = 'flash-message flash-warning';
        warning.innerHTML = `
            <strong>Warning:</strong> LeetCode SRS app doesn't appear to be running on localhost:1234.
            Start the app first, then reload this page.
            <button onclick="this.parentElement.remove()" class="flash-close">&times;</button>
        `;
        document.querySelector('.main-content').insertBefore(warning, document.querySelector('.bookmarklet-page'));
    });
</script>
{% endblock %}